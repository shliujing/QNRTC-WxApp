module.exports=function(modules){var installedModules={};function __webpack_require__(moduleId){if(installedModules[moduleId]){return installedModules[moduleId].exports}var module=installedModules[moduleId]={i:moduleId,l:false,exports:{}};modules[moduleId].call(module.exports,module,module.exports,__webpack_require__);module.l=true;return module.exports}__webpack_require__.m=modules;__webpack_require__.c=installedModules;__webpack_require__.d=function(exports,name,getter){if(!__webpack_require__.o(exports,name)){Object.defineProperty(exports,name,{enumerable:true,get:getter})}};__webpack_require__.r=function(exports){if(typeof Symbol!=="undefined"&&Symbol.toStringTag){Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"})}Object.defineProperty(exports,"__esModule",{value:true})};__webpack_require__.t=function(value,mode){if(mode&1)value=__webpack_require__(value);if(mode&8)return value;if(mode&4&&typeof value==="object"&&value&&value.__esModule)return value;var ns=Object.create(null);__webpack_require__.r(ns);Object.defineProperty(ns,"default",{enumerable:true,value:value});if(mode&2&&typeof value!="string")for(var key in value)__webpack_require__.d(ns,key,function(key){return value[key]}.bind(null,key));return ns};__webpack_require__.n=function(module){var getter=module&&module.__esModule?function getDefault(){return module["default"]}:function getModuleExports(){return module};__webpack_require__.d(getter,"a",getter);return getter};__webpack_require__.o=function(object,property){return Object.prototype.hasOwnProperty.call(object,property)};__webpack_require__.p="";return __webpack_require__(__webpack_require__.s=4)}([function(module,exports){module.exports=require("events")},function(module,exports,__webpack_require__){"use strict";exports.__esModule=true;exports.getRoomAccessFromToken=getRoomAccessFromToken;exports.timeout=timeout;exports.diff=void 0;var _jsBase=__webpack_require__(7);var _functions=__webpack_require__(3);function getRoomAccessFromToken(token){var roomAccessString=token.split(":")[2];var decoedString=_jsBase.Base64.decode(roomAccessString);console.log(decoedString);return JSON.parse(decoedString)}function timeout(ms){if(ms===void 0){ms=1e3}return new Promise(function(resolve){setTimeout(function(){resolve()},ms)})}var diff=function diff(prev,curr,identity1){if(prev===void 0){prev=[]}if(curr===void 0){curr=[]}if(identity1===void 0){identity1=_functions.identity}var diff={add:[],remove:[]};if(prev.length===0){diff.add=curr;return diff}if(curr.length===0){diff.remove=prev;return diff}var prevIds=prev.map(identity1);var currIds=curr.map(identity1);prevIds.forEach(function(id,i){if(currIds.indexOf(id)===-1){diff.remove.push(prev[i])}});currIds.forEach(function(id,i){if(prevIds.indexOf(id)===-1){diff.add.push(curr[i])}});return diff};exports.diff=diff},function(module,exports,__webpack_require__){"use strict";exports.__esModule=true;exports.version=void 0;var version="1.0.0-beta.0";exports.version=version},function(module,exports,__webpack_require__){"use strict";exports.__esModule=true;exports.propNotEq=exports.prop=exports.identity=void 0;var identity=function identity(x){return x};exports.identity=identity;var prop=function prop(name){return function(obj){return obj[name]}};exports.prop=prop;var propNotEq=function propNotEq(name,val){return function(obj){return obj[name]!==val}};exports.propNotEq=propNotEq},function(module,exports,__webpack_require__){"use strict";exports.__esModule=true;var _RoomSession=_interopRequireDefault(__webpack_require__(5));exports.RoomSession=_RoomSession.default;var _utils=_interopRequireDefault(__webpack_require__(1));exports.util=_utils.default;var _env=__webpack_require__(2);exports.version=_env.version;function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}console.log("QNRTC_Version: ",_env.version)},function(module,exports,__webpack_require__){"use strict";exports.__esModule=true;exports.default=void 0;var _events=__webpack_require__(0);var _Signaling=_interopRequireDefault(__webpack_require__(6));var _utils=__webpack_require__(1);var _functions=__webpack_require__(3);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _inheritsLoose(subClass,superClass){subClass.prototype=Object.create(superClass.prototype);subClass.prototype.constructor=subClass;subClass.__proto__=superClass}var RoomSession=function(_EventEmitter){_inheritsLoose(RoomSession,_EventEmitter);function RoomSession(props){var _this;_this=_EventEmitter.call(this)||this;_this.users=[];_this.tracks=[];_this.rtmphost="";_this.signalingurl="wss://rtmpgate.cloudvdn.com/";if(props&&props.server){_this.signalingurl=props.server}return _this}var _proto=RoomSession.prototype;_proto.joinRoomWithToken=function joinRoomWithToken(token,userData){var _this2=this;try{var roomAccess=(0,_utils.getRoomAccessFromToken)(token);this.userId=roomAccess.userId;this.roomName=roomAccess.roomName;this.appId=roomAccess.appId}catch(error){return Promise.reject(error)}this.ws=new _Signaling.default(this.signalingurl,this.appId,token,this.userId,this.roomName,userData);this.ws.on("#message",this.onMessage.bind(this));this.ws.on("@error",this.onError.bind(this));this.ws.on("#closed",function(){_this2.releaseRoom();_this2.emit("disconnected")});return this.ws.init().then(function(data){console.log("init",data);_this2.users=data.players||[];_this2.tracks=data.tracks||[];_this2.rtmptoken=data.rtmptoken;_this2.rtmphost=data.rtmphost;_this2.ws.on("connected",_this2.onConnected.bind(_this2));_this2.ws.on("reconnecting",function(){return _this2.emit("reconnecting")});return data})};_proto.onConnected=function onConnected(data){var _this3=this;console.log("connected",data);this.emit("reconnected");this.rtmptoken=data.rtmptoken;this.rtmphost=data.rtmphost;var users=data.players||[];var tracks=(data.tracks||[]).filter((0,_functions.propNotEq)("playerid",this.userId));var usersdiff=(0,_utils.diff)(this.users,users,(0,_functions.prop)("playerid"));var tracksdiff=(0,_utils.diff)(this.tracks,tracks,(0,_functions.prop)("trackid"));return Promise.resolve().then(function(){usersdiff.remove.forEach(_this3.handlePlayerOut,_this3);if(tracksdiff.remove.length>0){_this3.handleRemoveTracks({tracks:tracksdiff.remove})}usersdiff.add.forEach(_this3.handlePlayerIn,_this3);if(tracksdiff.add.length>0){_this3.handleAddTracks({tracks:tracksdiff.add})}return true})};_proto.onError=function onError(e){this.emit("error",e)};_proto.onMessage=function onMessage(type,data){console.log("[onmessage] "+type+": "+JSON.stringify(data));switch(type){case"on-player-in":{this.handlePlayerIn(data);break}case"on-player-out":{this.handlePlayerOut(data);break}case"on-add-tracks":{this.handleAddTracks(data);break}case"on-remove-tracks":{this.handleRemoveTracks(data);break}case"disconnect":{this.emit("disconnect",data);this.leaveRoom();break}default:}};_proto.handlePlayerIn=function handlePlayerIn(data){var index=this.users.indexOf(function(value){return value.playerid===data.playerid});if(index!==-1){this.users[index]=data}else{this.users.push(data)}this.emit("user-join",data)};_proto.handlePlayerOut=function handlePlayerOut(data){this.users=this.users.filter(function(value){return value.playerid!==data.playerid});this.emit("user-leave",data)};_proto.handleAddTracks=function handleAddTracks(data){var _this4=this;data.tracks.forEach(function(track){var index=_this4.tracks.indexOf(function(value){return value.trackid===track.trackid});if(index!==-1){_this4.tracks[index]=track}else{_this4.tracks.push(track)}});this.emit("track-add",data.tracks)};_proto.handleRemoveTracks=function handleRemoveTracks(data){this.tracks=this.tracks.filter(function(value){return!data.tracks.some(function(v){return v.trackid===value.trackid})});this.emit("track-remove",data.tracks)};_proto.publish=function publish(){return"rtmp://"+this.rtmphost+"/?rtmptoken="+this.rtmptoken+"&playerid="+this.userId};_proto.subscribe=function subscribe(playerid){if(!this.tracks||playerid===this.userId){return}var trackids=this.tracks.filter(function(v){return v.playerid===playerid&&v.master}).map(function(v){return v.trackid});if(trackids.length===0){return}return"rtmp://"+this.rtmphost+"/?rtmptoken="+this.rtmptoken+"&trackid="+trackids.join("&trackid=")+"&playerid="+playerid};_proto.leaveRoom=function leaveRoom(){if(this.ws){return this.ws.send("disconnect").then(this.releaseRoom.bind(this)).catch(this.releaseRoom.bind(this))}};_proto.releaseRoom=function releaseRoom(){this.removeAllListeners();if(this.ws){this.ws.close()}};return RoomSession}(_events.EventEmitter);exports.default=RoomSession},function(module,exports,__webpack_require__){"use strict";exports.__esModule=true;exports.default=exports.SignalingState=void 0;var _events=__webpack_require__(0);var _env=__webpack_require__(2);var _utils=__webpack_require__(1);var _WebSocket=_interopRequireDefault(__webpack_require__(8));function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _inheritsLoose(subClass,superClass){subClass.prototype=Object.create(superClass.prototype);subClass.prototype.constructor=subClass;subClass.__proto__=superClass}var SignalingState={CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3};exports.SignalingState=SignalingState;var Signaling=function(_EventEmitter){_inheritsLoose(Signaling,_EventEmitter);function Signaling(url,appId,token,userId,roomName,userData){var _this;_this=_EventEmitter.call(this)||this;_this.url=url;_this.app=appId;_this.accessToken=token;_this.user=userId;_this.room=roomName;_this.userData=userData||"";_this.reconnectTimeout=1e4;return _this}var _proto=Signaling.prototype;_proto.init=function init(){var _this2=this;return new Promise(function(resolve,reject){_this2._state=SignalingState.CONNECTING;if(_this2.ws){_this2.ws.silentClose()}var ws=new _WebSocket.default(_this2.url);ws.on("open",function(){console.log("socketopen");resolve(_this2.sendAuth().then(function(data){_this2._state=SignalingState.OPEN;ws.off("close",reject);ws.on("close",_this2.onClose.bind(_this2));_this2.rtmptoken=data.rtmptoken;_this2._state=SignalingState.OPEN;_this2.emit("connected",data);return data}))});ws.on("close",reject);ws.on("message",_this2.onMessage.bind(_this2));_this2.ws=ws})};_proto.onOpen=function onOpen(res){console.log("on socket open",res);this.emit("#open",res)};_proto.onClose=function onClose(res){console.log("on socket close: ",res.code);switch(Number(res.code)){case 1e3:{this._state=SignalingState.CLOSED;this.emit("#closed",res);break}case 1001:{this.reconnect();break}case 1005:{this.reconnect();break}case 1006:{this.reconnect();break}case 1011:{this.reconnect();break}case 1012:{this.reconnect(5e3);break}case 1013:{this.reconnect();break}case 1014:{this.reconnect(5e3);break}default:{break}}};_proto.onError=function onError(res){console.log("on socket error",res);this.emit("#error",res)};_proto.onMessage=function onMessage(_ref){var data=_ref.data;console.info(Date.now().toLocaleString()+" onmessage "+data);var index=data.indexOf("=");if(index>0){var msgType=data.substring(0,index);var payload=JSON.parse(data.substring(index+1));this.receiveWsMsg(msgType,payload)}};_proto.receiveWsMsg=function receiveWsMsg(msgType,payload){if(msgType==="ping"){this.handlePing()}else if(payload.rpcid){this.emit("#message#"+payload.rpcid,msgType,payload)}else{this.emit("#message",msgType,payload)}};_proto.send=function send(type,message){if(message===void 0){message={}}if(!this.ws){return}var data=type+"="+JSON.stringify(message);return this.ws.send(data)};_proto.request=function request(type,message){var _this3=this;if(message===void 0){message={}}return new Promise(function(resolve,reject){var rpcid=Math.random().toString(36).substring(7);message.rpcid=rpcid;_this3.send(type,message).catch(reject);console.log("send: "+type+JSON.stringify(message));_this3.once("#message#"+rpcid,function(type,data){if(data.code===0){resolve(data)}else{reject(data)}})})};_proto.close=function close(){if(this.reconnectTimeoutID){clearTimeout(this.reconnectTimeoutID)}if(!this.ws){return}this.ws.close()};_proto.handlePing=function handlePing(){var _this4=this;this.send("pong",{});if(this.reconnectTimeoutID){clearTimeout(this.reconnectTimeoutID)}this.reconnectTimeoutID=setTimeout(function(){console.log("signaling: websocket heartbeat timeout");_this4.emit("timeout","signaling: websocket heartbeat timeout");_this4.reconnect()},9e3)};_proto.reconnect=function reconnect(time){var _this5=this;if(time===void 0){time=1e3}if(this.reconnectTimeoutID){clearTimeout(this.reconnectTimeoutID)}if(this._state===SignalingState.CLOSED){this.ws.silentClose();this.emit("#error");return Promise.resolve()}if(this.reconnectPromise){return this.reconnectPromise}if(this.reconnectTimeoutID===undefined){this.reconnectTimeoutID=setTimeout(function(){_this5._state=SignalingState.CLOSED;_this5.reconnectTimeoutID=undefined},this.reconnectTimeout)}this._state=SignalingState.CONNECTING;this.emit("reconnecting");console.log("signaling: websocket reconnecting");this.reconnectPromise=(0,_utils.timeout)(time).then(this.init.bind(this)).then(function(res){_this5.reconnectPromise=undefined;console.log("signaling: websocket reconnected");return res}).catch(function(e){_this5.reconnectPromise=undefined;if(e.code){if(e.code===10001){_this5._state=SignalingState.CLOSED}else{return _this5.reconnect()}}console.log("signaling: websocket reconnect fail",e);_this5.ws.close();_this5.emit("@error",e);return Promise.reject(e)});return this.reconnectPromise};_proto.sendAuth=function sendAuth(){var params;if(this.rtmptoken){params={rtmptoken:this.rtmptoken}}else{params={app:this.app,agent:"wechat miniprogram",roomtoken:this.accessToken,sdkversion:_env.version,room:this.room,user:this.user}}return this.request("auth",params)};return Signaling}(_events.EventEmitter);exports.default=Signaling},function(module,exports){module.exports=require("js-base64")},function(module,exports,__webpack_require__){"use strict";exports.__esModule=true;exports.default=void 0;var _events=__webpack_require__(0);function _assertThisInitialized(self){if(self===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return self}function _inheritsLoose(subClass,superClass){subClass.prototype=Object.create(superClass.prototype);subClass.prototype.constructor=subClass;subClass.__proto__=superClass}var WebSocket=function(_EventEmitter){_inheritsLoose(WebSocket,_EventEmitter);function WebSocket(url){var _this;_this=_EventEmitter.call(this)||this;_this.socketTask=wx.connectSocket({url:url,success:function success(msg){console.log("success:"+JSON.stringify(msg))},fail:function fail(data){console.log("fail:"+JSON.stringify(data))}});_this.socketTask.onClose(_this.emit.bind(_assertThisInitialized(_this),"close"));_this.socketTask.onError(_this.emit.bind(_assertThisInitialized(_this),"error"));_this.socketTask.onMessage(_this.emit.bind(_assertThisInitialized(_this),"message"));_this.socketTask.onOpen(_this.emit.bind(_assertThisInitialized(_this),"open"));return _this}var _proto=WebSocket.prototype;_proto.send=function send(data){var _this2=this;return new Promise(function(resolve,reject){try{_this2.socketTask.send({data:data,success:resolve,fail:reject})}catch(err){reject(err)}})};_proto.close=function close(){return this.socketTask.close()};_proto.silentClose=function silentClose(){this.removeAllListeners();return this.socketTask.close()};return WebSocket}(_events.EventEmitter);exports.default=WebSocket}]);
